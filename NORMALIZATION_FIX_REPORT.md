# КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Нормировка P-члена в формуле Вейля

## Найденная ошибка

В файлах `sigma_critical_region.py` и всех предыдущих версиях **отсутствовал фактор 1/(2π)** в простом члене P:

```python
# БЫЛО (неправильно):
P += 2 * (log_p / np.sqrt(p)) * h_hat(log_p)  # ❌ нет 1/(2π)

# СТАЛО (правильно):
P += (2 * (log_p / np.sqrt(p)) * h_hat(log_p)) / (2*np.pi)  # ✅
```

## Влияние на результаты

### До исправления:
- σ=1: Q = -5.53 (P=6.72 доминирует) ❌
- σ=2: Q = -0.91 (P=2.57) ❌
- σ=5: Q = +0.96 (узкое окно) ✅
- Критический интервал: σ ∈ [2.35, 6.65]
- **Вывод был неверным**: "При малых σ доминирует P → Q < 0"

### После исправления:
- σ=1: Q = +0.13 (P=1.07) ✅
- σ=2: Q = +1.25 (P=0.41) ✅
- σ=5: Q = +1.98 (P=0.005) ✅
- **Нижняя граница исчезла!**
- Q > 0 начинается с σ ≈ 0.93
- Q остаётся положительным для всех σ > 1

## Математическое обоснование

### Единая Фурье-конвенция
```
ĥ(ξ) = ∫_{-∞}^{∞} h(t) e^{-iξt} dt
h(t) = (1/2π) ∫_{-∞}^{∞} ĥ(ξ) e^{iξt} dξ
```

### Explicit формула Вейля
```
Q(h) = Z(h) - A(h) - P(h) ≥ 0 (если RH верна)
```

Где все члены в частотной формулировке требуют 1/(2π):
- Z = Σ_ρ h(γ_ρ) (во временной области, без 1/(2π))
- A = ∫ h(t) * weight(t) dt / (2π)
- P = Σ_n (2Λ(n)/√n) * ĥ(log n) / (2π)

## Проверка результатов

### 1. Фактор нормировки
```
P_old / P_new = 6.283... = 2π ✓
```

### 2. Грам-матрица PSD
Для σ = {2, 3, 4, 5, 6}:
```
Собственные значения: все ≥ -8e-15 (численный ноль)
Матрица PSD ✓
```

### 3. Хвостовые ошибки
Для σ = 5:
- Z-хвост (γ > 101): < 1e-90
- P-хвост (n > 600): < 1e-223  
- A-квадратура: < 3e-9
- **Относительная ошибка < 0.0001%**

## Выводы

1. **Критическая ошибка найдена и исправлена**: отсутствовал фактор 1/(2π) в P-члене

2. **"Узкий интервал" был артефактом**: после исправления Q > 0 для всех σ > 0.93

3. **Результат согласуется с RH**: Q ≥ 0 для гауссовых тест-функций при σ ≥ 1

4. **Максимум Q при σ ≈ 5 остался**: это оптимальный баланс между Z, A и P

5. **Критерий Вейля**: положительность для одной параметрической семьи согласуется с RH, но не доказывает её (нужна положительность для ВСЕХ допустимых функций)

## Код для воспроизведения

```python
# test_bench.py - минимальный эталон с правильной нормировкой
# verify_fix.py - сравнение старой и новой формул
# sigma_critical_region.py - исправленная версия
```

## Математическая корректность

✅ Единая Фурье-конвенция везде  
✅ Согласованность temporal/frequency форм  
✅ Правильные нормировочные факторы  
✅ Адаптивные пределы интегрирования  
✅ Контроль хвостовых ошибок

---

**Урок**: Даже маленькая ошибка в нормировке может кардинально изменить выводы. Всегда проверяй размерности и константы!